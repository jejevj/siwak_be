# Use the official PHP image with Apache
FROM php:8.2-apache

# Install system dependencies for Laravel (including Composer, Git, PHP extensions, PostgreSQL dependencies)
RUN apt-get update && apt-get install -y \
    libpng-dev libjpeg-dev libfreetype6-dev \
    libzip-dev git unzip libpq-dev && \
    docker-php-ext-configure gd --with-freetype --with-jpeg && \
    docker-php-ext-install gd zip pdo pdo_mysql pdo_pgsql pgsql && \
    apt-get clean

# Install Composer globally
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Set the working directory in the container
WORKDIR /var/www/html

# Copy the Laravel project into the container (superuser root permissions will apply)
COPY . .

# Install Laravel dependencies using Composer (runs with root access)
RUN composer install --optimize-autoloader --no-dev

# Configure PHP to accept big files and allow longer execution time
RUN echo "upload_max_filesize = 100M" >> /usr/local/etc/php/conf.d/uploads.ini && \
    echo "post_max_size = 100M" >> /usr/local/etc/php/conf.d/uploads.ini && \
    echo "max_execution_time = 300" >> /usr/local/etc/php/conf.d/uploads.ini && \
    echo "max_input_time = 300" >> /usr/local/etc/php/conf.d/uploads.ini && \
    echo "memory_limit = 512M" >> /usr/local/etc/php/conf.d/uploads.ini

# Expose port 8000 (for the Laravel development server)
EXPOSE 8000

# Set the command to run the Laravel development server
CMD ["php", "artisan", "serve", "--host=0.0.0.0", "--port=8000"]
